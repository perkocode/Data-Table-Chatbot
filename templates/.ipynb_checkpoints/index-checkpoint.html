<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Superstore Chatbot</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Superstore Chatbot</h1>

    <!-- File Upload + Dataset Naming -->
    <form id="upload-form" enctype="multipart/form-data">
        <label for="dataset_name">Dataset Name:</label>
        <input type="text" id="dataset_name" name="dataset_name" required>

        <label for="file">Upload CSV (max 50MB):</label>
        <input type="file" id="file" name="file" accept=".csv" required>

        <button type="submit">Upload Dataset</button>
    </form>

    <hr>

    <!-- Dataset Selection Dropdown -->
    <label for="dataset-select">Choose Dataset:</label>
    <select id="dataset-select" name="dataset_name">
        <option value="global_superstore">Global Superstore</option>
    </select>

    <hr>

    <!-- Question Input -->
    <form id="ask-form">
    <label for="question">Ask a question:</label><br>
    <textarea id="question" name="question" rows="4" cols="50" required></textarea><br>

    <input type="hidden" id="selected-dataset" name="dataset_name" value="global_superstore">

    <button type="submit">Ask</button>
    </form>

    <div id="response"></div>


    <script>
        // Update hidden input with selected dataset
        $('#dataset-select').on('change', function () {
            $('#selected-dataset').val(this.value);
        });

        // Handle file upload
        $('#upload-form').on('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);

            $.ajax({
                url: '/upload',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    console.log("Upload response:", response);  // Add this line
                    alert(response.message);
                    updateDropdown(response.datasets, response.default_dataset);
                },
                error: function (xhr) {
                    alert(xhr.responseJSON?.error || xhr.statusText || "Upload failed.");
                }
            });
        });

        // Handle question form submission
        $('#ask-form').on('submit', function (e) {
            e.preventDefault();
        
            const formData = {
                question: $('#question').val(),
                dataset_name: $('#selected-dataset').val()
            };
        
            $.ajax({
                url: '/ask',
                type: 'POST',
                data: formData,
                success: function (response) {
                    $('#response').html(
                        `<h3>${response.answer}</h3>` +
                        (response.preview ? `<pre>${JSON.stringify(response.preview, null, 2)}</pre>` : '')
                    );
                },
                error: function (xhr) {
                    $('#response').html(`<p style="color: red;">${xhr.responseJSON?.error || "Error processing request."}</p>`);
                }
            });
        });


        // Update dropdown with uploaded datasets
        function updateDropdown(datasets, defaultDataset) {
            if (!datasets || !Array.isArray(datasets)) {
                console.error("Invalid datasets passed to updateDropdown:", datasets);
                return;
            }

            const dropdown = document.getElementById("dataset-select");
            dropdown.innerHTML = "";
    
            datasets.forEach(function (dataset) {
            const option = document.createElement("option");
            option.value = dataset;
            option.textContent = dataset;
            if (dataset === defaultDataset) {
                option.selected = true;
            }
            dropdown.appendChild(option);

            // ðŸ”‘ Sync the newly selected item with the hidden input
            $(dropdown).trigger('change');
            });
        }
    </script>
</body>
</html>
